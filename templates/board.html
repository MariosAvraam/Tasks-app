{% extends "base.html" %}
{% block content %}
<h2 class="text-center">
  {{ board.title }}
</h2>
<div class="text-center mb-4">
  <a href="{{ url_for('add_column', board_id=board.id) }}" class="btn btn-primary mb-3">
    <i class="fas fa-plus-circle"></i> Add Column
  </a>
</div>
<div class="board-columns">
  {% for column in columns %}
  <div class="column" data-column-id="{{ column.id }}">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3>
        {{ column.title }}
      </h3>
      <div>
        <a href="{{ url_for('edit_column', column_id=column.id) }}" class="btn btn-light btn-sm">
          <i class="fas fa-edit"></i>
        </a>
        <form action="{{ url_for('delete_column', column_id=column.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this column?');">
          <button type="submit" class="btn btn-danger btn-sm">
            <i class="fas fa-trash-alt"></i>
          </button>
        </form>
      </div>
    </div>
    <ul class="draggable-list">
      {% for task in column.tasks %}
      <li data-task-id="{{ task.id }}">
        <div class="{% if task.priority == 'high' %}alert alert-danger d-flex align-items-center justify-content-between{% elif task.priority == 'medium' %}alert alert-warning d-flex align-items-center justify-content-between{% else %}alert alert-success d-flex align-items-center justify-content-between{% endif %}">
          <span>
            {{ task.task }}</span>
          <div>
            <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-light btn-sm mr-2">
              <i class="fas fa-edit"></i>
            </a>
            <form action="{{ url_for('delete_task', task_id=task.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this task?');">
              <button type="submit" class="btn btn-danger btn-sm">
                <i class="fas fa-trash-alt"></i>
              </button>
            </form>
          </div>
        </div>
      </li>
      {% endfor %}
    </ul>
    <a href="{{ url_for('add_task', board_id=board.id, column_id=column.id) }}" class="btn btn-success mb-3">
      <i class="fas fa-plus-circle"></i> Add Task
    </a>
  </div>
  {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Using Dragula to make the task lists draggable
    var drake = dragula([].slice.call(document.querySelectorAll('.column ul')));

    drake.on('drop', function(el, target, source, sibling) {
      // When a task is dropped, send AJAX request to update the task's column in the database
      var taskId = el.getAttribute('data-task-id');
      var newColumnId = target.parentElement.getAttribute('data-column-id');

      fetch('/update_task_column', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          task_id: taskId,
          column_id: newColumnId
        })
      }).then(response => response.json()).then(data => {
        if (data.status !== 'success') {
          alert('Failed to move task. Please try again.');
        }
      });
    });
  });
</script>
{% endblock %}
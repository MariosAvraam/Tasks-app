{% extends "base.html" %}
{% block content %}
<h2>
  {{ board.title }}
</h2>
<a href="{{ url_for('add_column', board_id=board.id) }}">Add Column</a>
<div class="board-columns">
  {% for column in columns %}
  <div class="column" data-column-id="{{ column.id }}">
    <h3>
      {{ column.title }}
    </h3>
    <a href="{{ url_for('edit_column', column_id=column.id) }}">Edit Column Name</a>
    <form action="{{ url_for('delete_column', column_id=column.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this column?');">
      <input type="submit" value="Delete Column" class="btn btn-danger btn-sm">
    </form>
    <ul class="draggable-list">
      {% for task in column.tasks %}
      <li data-task-id="{{ task.id }}">
        <div class="{% if task.priority == 'high' %}alert alert-danger{% elif task.priority == 'medium' %}alert alert-warning{% else %}alert alert-success{% endif %}">
          {{ task.task }}
          <a href="{{ url_for('edit_task', task_id=task.id) }}">Edit Task</a>
          <form action="{{ url_for('delete_task', task_id=task.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this task?');">
        </div>
        <input type="submit" value="Delete Task" class="btn btn-danger btn-sm">
        </form>
      </li>
      {% endfor %}
    </ul>
    <a href="{{ url_for('add_task', board_id=board.id, column_id=column.id) }}">Add Task</a>
  </div>
  {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Using Dragula to make the task lists draggable
    var drake = dragula([].slice.call(document.querySelectorAll('.column ul')));

    drake.on('drop', function(el, target, source, sibling) {
      // When a task is dropped, send AJAX request to update the task's column in the database
      var taskId = el.getAttribute('data-task-id');
      var newColumnId = target.parentElement.getAttribute('data-column-id');

      fetch('/update_task_column', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          task_id: taskId,
          column_id: newColumnId
        })
      }).then(response => response.json()).then(data => {
        if (data.status !== 'success') {
          alert('Failed to move task. Please try again.');
        }
      });
    });
  });
</script>
{% endblock %}